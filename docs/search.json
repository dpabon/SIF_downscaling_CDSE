[
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "",
    "text": "In the following example we will Downscaled (Increase the spatial resolution) of Sun Induced Fluorescence product derived from Sentinel-5p TROPOMI sensor. A full workflow diagram is presented here: XXXXX"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#introduction",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#introduction",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "",
    "text": "In the following example we will Downscaled (Increase the spatial resolution) of Sun Induced Fluorescence product derived from Sentinel-5p TROPOMI sensor. A full workflow diagram is presented here: XXXXX"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#libraries",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#libraries",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Libraries",
    "text": "Libraries\nWe will need the following libraries to run dowscaling processor\n\nimport openeo\nimport rioxarray as rio\n\n\"\"\"\nCurrently there is an issue with openEO back-end that doesnt allow us to upsample datacubes (For more details see [here](https://forum.dataspace.copernicus.eu/t/how-to-spatial-upsampling-when-using-resample-cube-spatial/4358/6)). For this reason we will need some other libraries to process the parameters cube locally, perform a spatial upsample, create a stac catalog and publish the file and catalog on github.\nThis is needed to create a STAC item for the upsampled parameters:\n\"\"\"\nimport pystac\nfrom pystac.extensions.projection import ProjectionExtension\nfrom pystac.extensions.eo import EOExtension\nfrom datetime import datetime\nfrom shapely.geometry import box, mapping\nimport json\nimport subprocess\n\n# For data visualization\nimport xarray as xr\nimport matplotlib.pyplot as plt"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#area-of-interest-and-time-period",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#area-of-interest-and-time-period",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Area of Interest and Time Period",
    "text": "Area of Interest and Time Period\nBefore going into the details of the datasets we need to define an area of interest and time period of our analysis. For this example we will focus in the north part of Germany in the period between 2018-06-20 and 2018-06-30.\n\nspatial_extent_prototype = {\n    \"west\": -6.921387,\n    \"east\": -1.889648,\n    \"south\": 37.230328,\n    \"north\": 40.229218,\n}\n\ntemporal_extent_prototype = [\"2018-06-23\", \"2018-06-30\"]"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#connecting-to-cdse-using-openeo",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#connecting-to-cdse-using-openeo",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Connecting to CDSE using openEO",
    "text": "Connecting to CDSE using openEO\nTo connect to the openEO insfrastructure in the CDSE we need to create a connection:\n\nconnection = openeo.connect(\n    \"https://openeofed.dataspace.copernicus.eu/\"\n).authenticate_oidc()\n\nAuthenticated using refresh token.\n\n\nThis will open a tab in the web-browser where the user needs to authenticate using the CDSE credentials. For more details on openEO in CDSE please see: https://dataspace.copernicus.eu/analyse/openeo\nThen we can see the data collections that are available:\n\nconnection.list_collections()"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#variables",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#variables",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Variables",
    "text": "Variables\nFor this tutorial we will use the following datasets/variables:\nTarget:\n\n\n\nVariable name\nCollection\nBand Name\nSpatial resolution\n\n\n\n\nSun-Induced Flourescence\nDong Li SIF\nSIF\n5 km\n\n\n\nCurrently there are two SIF gridded products derived from Sentinel-5p that are availables:\n\nS5P-PAL SIF. This product is generated by the Sentinel-5P Product Algorithm Laboratory (S5P-PAL) and contains modified Copernicus Sentinel data processed by S[&]T. Unfortunately, the current (at least at: 2025-12-01) STAC dissemination only include plain netcdf files and not cloud optimized data format. Currently the Atmosphere Virtual Lab project is working in provided zarr datacubes for the L3 products, including SIF.\nDong LI SIF. This product uses an artificial neural network to retrieve SIF from Sentinel-5p observations. Thanks to Dong Li for provinding us with a gridded example of the product and the stac item necessary to ingest the product in the openEO-CDSE infrastructure. This files can be found in the data directory of the repository.\n\nPredictors:\n\n\n\n\n\n\n\n\n\nVariable name\nCollection\nBand Name\nSpatial resolution\n\n\n\n\nLand Surface Temperature\nSENTINEL3_SLSTR_L2_LST\nLST\n1 km\n\n\nTerrestrial Chlorophyll Index\nSENTINEL3_OLCI_L2_LAND\nOTCI\n300 m\n\n\nIntegrated Water Vapour\nSENTINEL3_OLCI_L2_LAND\nIWV\n300 m\n\n\n\n\nCreating openEO datacubes for the variables\n\n# Testing SIF - Dong Li\n\ncube_SIF_original_median = connection.load_stac(\n    \"https://raw.githubusercontent.com/dpabon/SIF_downscaling_CDSE/refs/heads/main/data/SIF_20180629.json\",\n    bands=[\"SIF\"],\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n)\n\n\ncube_LST = connection.load_collection(\n    \"SENTINEL3_SLSTR_L2_LST\",\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n    bands=[\"LST\"],\n)\n\ncube_LST_qc = connection.load_collection(\n    \"SENTINEL3_SLSTR_L2_LST\",\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n    bands=[\"confidence_in\"],\n)\n\ncube_OTCI = connection.load_collection(\n    \"SENTINEL3_OLCI_L2_LAND\",\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n    bands=[\"OTCI\"],\n)\n\ncube_IWV = connection.load_collection(\n    \"SENTINEL3_OLCI_L2_LAND\",\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n    bands=[\"IWV\"],\n)\n\ncube_OLCI_qc = connection.load_collection(\n    \"SENTINEL3_OLCI_L2_LAND\",\n    spatial_extent=spatial_extent_prototype,\n    temporal_extent=temporal_extent_prototype,\n    bands=[\"LQSF\"],\n)\n\n\n\nMasking clouds\n\nmask = cube_LST_qc &gt; 5000\n\ncube_LST_masked = cube_LST.mask(mask)\n\n\nmask_olci = cube_OLCI_qc &gt; 10000\n\ncube_OTCI_masked = cube_OTCI.mask(mask_olci)\n\ncube_IWV_masked = cube_IWV.mask(mask_olci)\n\nIf we call one of the cubes we can see the process graph that is created by openEO:\n\ncube_LST_masked"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#reducing-the-time-dimension",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#reducing-the-time-dimension",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Reducing the time dimension",
    "text": "Reducing the time dimension\nFor this analysis we will compute a composite of the area of interest using all the observations during the time period for all the variables except SIF that is already one time step observation.\n\ncube_SIF_original_median = cube_SIF_original_median.reduce_temporal(reducer=\"median\")\n\n\ncube_LST_median = cube_LST_masked.reduce_temporal(reducer=\"median\")\n\ncube_OTCI_median = cube_OTCI_masked.reduce_temporal(reducer=\"median\")\n\ncube_IWV_median = cube_IWV_masked.reduce_temporal(reducer=\"median\")\n\n\ncube_LST_median"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#inspecting-the-variables",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#inspecting-the-variables",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Inspecting the variables",
    "text": "Inspecting the variables\nThen we will inspect the products, for that we need to execute the processors for each cube, save it locally, open and plot.\n\n# cube_SIF_original_median.execute_batch(outputfile=\"data/cube_SIF_median.tif\")\n# cube_LST_median.execute_batch(outputfile=\"data/cube_LST_median.tif\")\n# cube_OTCI_median.execute_batch(outputfile=\"data/cube_OTCI_median.tif\")\n# cube_IWV_median.execute_batch(outputfile=\"data/cube_IWV_median.tif\")\n\n\ncube_sif_local = rio.open_rasterio(\n    filename=\"data/cube_SIF_median.tif\", mask_and_scale=True\n)\ncube_lst_local = rio.open_rasterio(filename=\"data/cube_LST_median.tif\")\ncube_otci_local = rio.open_rasterio(filename=\"data/cube_OTCI_median.tif\")\ncube_iwv_local = rio.open_rasterio(filename=\"data/cube_IWV_median.tif\")\n\n\nfig, axs = plt.subplots(nrows=4, figsize=(6, 15))\ncube_sif_local.plot(ax=axs[0])\naxs[0].set_title(\"SIF\")\ncube_lst_local.plot(ax=axs[1])\naxs[1].set_title(\"LST\")\ncube_otci_local.plot(ax=axs[2])\naxs[2].set_title(\"OTCI\")\ncube_iwv_local.plot(ax=axs[3])\naxs[3].set_title(\"IWV\")\n\nText(0.5, 1.0, 'IWV')\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nImportant\n\n\n\nThe LST composite looks heavily influenced by the orbits. For sure can do better…for example Terrascope Sentinel-3 Level 3 Land Surface Temperature daily synthesis product\nOR maybe Sentinel-3 SYN SLSTR bands…"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#spatial-resampling-to-match-the-sif-resolution-product",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#spatial-resampling-to-match-the-sif-resolution-product",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Spatial resampling to match the SIF resolution product",
    "text": "Spatial resampling to match the SIF resolution product\n\ncube_LST_median_low = cube_LST_median.resample_cube_spatial(\n    target=cube_SIF_original_median, method=\"bilinear\"\n)\n\ncube_OTCI_median_low = cube_OTCI_median.resample_cube_spatial(\n    target=cube_SIF_original_median, method=\"bilinear\"\n)\n\ncube_IWV_median_low = cube_IWV_median.resample_cube_spatial(\n    target=cube_SIF_original_median, method=\"bilinear\"\n)\n\nMerging all the cubes at low resolution (SIF original resolution)\n\ndataset_SIF_low = cube_SIF_original_median.merge_cubes(cube_LST_median_low)\n\ndataset_SIF_low = dataset_SIF_low.merge_cubes(cube_OTCI_median_low)\n\ndataset_SIF_low = dataset_SIF_low.merge_cubes(cube_IWV_median_low)\n\nAdding two dummy variables to the datacube to match the number of oputput parameters of the optimization function.\n\ndataset_SIF_low = dataset_SIF_low.merge_cubes(\n    other=cube_SIF_original_median.rename_labels(dimension=\"bands\", target=[\"dummy_1\"])\n)\ndataset_SIF_low = dataset_SIF_low.merge_cubes(\n    other=cube_SIF_original_median.rename_labels(dimension=\"bands\", target=[\"dummy_2\"])\n)"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#sif-parameter-optimization-at-low-spatial-resolution",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#sif-parameter-optimization-at-low-spatial-resolution",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "SIF parameter optimization at low spatial resolution",
    "text": "SIF parameter optimization at low spatial resolution\nTo predict SIF we use the following formulation: \\[SIF = f(V) \\cdot f(W) \\cdot f(T)\\]\nwhere \\(f(V)\\) represents the vegetation module and \\(V\\) is a vegation index: \\[f(V) = b_2 \\cdot V^{b_1}\\]\n\\(f(W)\\) represents the water module where \\(W\\) represent a water availabiliy variables (e.g. ET, NDWI): \\[\nf(W) = \\frac{1}{1 + e^{b_3 \\cdot (b_4 - W)}}\n\\]\nFinally \\(f(T)\\) represents the temperature module where \\(T\\) is a variable that represent temperature stress (e.g. air temperature at 2 meters, or land surface temperature)\n\\[\nf(T) = e^{-\\frac{(T + b_5)^2}{2b_6^2}}\n\\]\nGiven the previous formulation we optimize the function using L-BFGS-B and a spatial moving window with 40 observations. The optimization function is defined in sif_downscaling_openEO_CDSE/udf/udf_parameters_optim_low_res.py.\nFirst we need to define the boundaries and start values for \\(b1\\), \\(b2\\), \\(b3\\), \\(b4\\), \\(b5\\) parameters:\n\n# the order for each variable follows: b1,b2,b3,b4,b5,b6\n\nparam_min = [3, 1, 0.0, -1, -310, 1]\n\nparam_ini = [1, 2, 50.0, 0, -295, 10]\n\nparam_max = [6, 10, 500.0, 1, -290, 50]\n\nTo apply the optimization function in the data cube we define an openEO User Define Function using:\n\nmy_udf = openeo.UDF.from_file(\n    \"sif_downscaling_openEO_CDSE/udf/udf_parameters_optim_low_res.py\",\n    context={\n        \"param_ini\": param_ini,\n        \"param_min\": param_min,\n        \"param_max\": param_max,\n        \"min_obs\": 25,\n        \"window_size_lat\": 6,\n        \"window_size_lon\": 7,\n    },\n)\n\nNotice that the size of the moving window is set using window_size_lat and window_size_lon.\nThen we can apply our function to the data cube using:\n\nparameters_cube_low = dataset_SIF_low.apply_neighborhood(\n    process=my_udf,\n    size=[\n        {\"dimension\": \"x\", \"value\": 512, \"unit\": \"px\"},\n        {\"dimension\": \"y\", \"value\": 512, \"unit\": \"px\"},\n    ],\n    overlap=[\n        {\"dimension\": \"x\", \"value\": 0, \"unit\": \"px\"},\n        {\"dimension\": \"y\", \"value\": 0, \"unit\": \"px\"},\n    ],\n)\n\n# changing the name of the ouput\noutput_bands = [\"b1\", \"b2\", \"b3\", \"b4\", \"b5\", \"b6\"]\n\nparameters_cube_low_rename = parameters_cube_low.rename_labels(\"bands\", output_bands)\n\nand see the process graph:\n\nparameters_cube_low_rename\n\n\n    \n    \n        \n    \n    \n\n\nNow we will download the cube the optimized parameters to have a look and spatially upsample to match the Sentinel-3 cube at high resolution.\n\n\"\"\"\nparameters_cube_low_rename.execute_batch(outputfile=\"data/results_parameters_optim_low_resolution.tif\")\n\"\"\"\n\n'\\nparameters_cube_low_rename.execute_batch(outputfile=\"data/results_parameters_optim_low_resolution.tif\")\\n'"
  },
  {
    "objectID": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#checking-parameter-optimization-results",
    "href": "sif_downscaling_openEO_CDSE/openEO_sif_downscaling_documented_and_plots.html#checking-parameter-optimization-results",
    "title": "SIF Downscaling using OpenEO and the Copernicus Data Space Ecosystem (CDSE)",
    "section": "Checking parameter optimization results",
    "text": "Checking parameter optimization results"
  }
]